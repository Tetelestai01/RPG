<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RPG Betsim - Miss√£o da Chave</title>
<style>
/* Mantendo o design pedido: escuro, simples, mobile-first */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Segoe UI",Arial,sans-serif;background:#0f1720;color:#e6eef6;padding-top:100px}
header{position:fixed;top:0;left:0;width:100%;background:#0b1220;color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:8px;z-index:200}
.header-left{display:flex;flex-direction:column;align-items:flex-start}
.header-right{display:flex;gap:8px;align-items:center}
.hudline{font-size:14px}
.btn{background:#1f2a44;color:#fff;border:none;padding:10px 12px;border-radius:10px;font-size:15px;cursor:pointer}
.btn:hover{opacity:.95}
.btn-secondary{background:#3b475f}
.btn-danger{background:#8b2e2e}
.card{background:#071222;margin:16px auto;border-radius:12px;padding:18px;max-width:520px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
.title{font-size:20px;margin-bottom:8px;color:#f8fafc}
.p{color:#cfe7ff;margin-bottom:10px;line-height:1.4}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.small{font-size:13px;color:#bcd7ff}
.output{background:#071b2a;padding:12px;border-radius:8px;max-height:360px;overflow:auto;color:#cfe7ff;margin-top:10px;white-space:pre-wrap}
.hidden{display:none}
.list-inline{display:flex;gap:6px;flex-wrap:wrap}
.inventory li{margin-bottom:8px}
footer{padding:20px;text-align:center;color:#93b7d8;font-size:13px}
@media(max-width:520px){
 header{padding:8px}
 .card{margin:10px;border-radius:10px;padding:14px}
 .btn{padding:8px 10px;font-size:14px}
}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <div id="nomeJogador" class="hudline">Jogador</div>
    <div id="atributosJogador" class="small">PV:0 Ouro:50 M√£o:Vazio V(0) F(0) D(0) A(0)</div>
  </div>
  <div class="header-right">
    <button class="btn btn-secondary" onclick="abrirPerfil()">Perfil</button>
    <button class="btn btn-secondary" onclick="toggleMenu()">Menu</button>
  </div>
</header>

<!-- Menu flutuante -->
<div id="menuOpcao" class="card hidden" style="position:fixed;right:12px;top:62px;z-index:201;max-width:300px">
  <div class="title">Menu</div>
  <div class="controls">
    <button class="btn" onclick="pauseJogo()">Pause</button>
    <button class="btn btn-danger" onclick="sairJogo()">Sair do Jogo</button>
    <button class="btn btn-secondary" onclick="reiniciarJogo()">Reiniciar Ficha</button>
    <button class="btn btn-secondary" onclick="toggleMenu()">Fechar</button>
  </div>
</div>

<main>
  <!-- Tela Inicial -->
  <section id="telaInicial" class="card">
    <div class="title">RPG Betsim ‚Äî Miss√£o da Chave</div>
    <p class="p">O Rei Robert convoca voc√™ para reunir os 4 fragmentos da chave da grande caverna. Sem a chave completa, o drag√£o de Luparus n√£o pode ser derrotado.</p>
    <div class="controls">
      <button id="btnCriarFicha" class="btn" onclick="editarFicha()">Criar / Editar Ficha</button>
      <button id="btnIniciarJogo" class="btn hidden" onclick="iniciarJogo()">Iniciar Aventura</button>
    </div>
    <div class="small" style="margin-top:10px" id="msgCrieFicha">Crie seu personagem para iniciar.</div>
  </section>

  <!-- Tela Ficha -->
  <section id="telaFicha" class="card hidden">
    <div class="title">Cria√ß√£o de Personagem</div>
    <div class="p">
      <label>Nome: <input id="inputNome" style="padding:8px;border-radius:8px;border:1px solid #274563;background:#071322;color:#e6eef6"/></label>
    </div>
    <div class="p small">Distribua 10 pontos entre os atributos.</div>
    <div style="display:grid;gap:8px">
      <label class="small">Vigor (cada ponto = 10 PV) <input id="attrVigor" type="number" min="0" max="10" value="3" onchange="atualizaPontos()"/></label>
      <label class="small">For√ßa <input id="attrForca" type="number" min="0" max="10" value="3" onchange="atualizaPontos()"/></label>
      <label class="small">Destreza <input id="attrDestreza" type="number" min="0" max="10" value="2" onchange="atualizaPontos()"/></label>
      <label class="small">Armadura <input id="attrArmadura" type="number" min="0" max="10" value="2" onchange="atualizaPontos()"/></label>
      <div class="small">Pontos restantes: <span id="pontosDisponiveis">0</span></div>
    </div>
    <div class="controls" style="margin-top:12px;">
      <button class="btn" onclick="salvarFicha()">Salvar Ficha</button>
      <button class="btn btn-secondary" onclick="mostrarTela('telaInicial')">Voltar</button>
    </div>
    <div id="mensagemFicha" class="small" style="margin-top:10px;color:#a7c6e6"></div>
  </section>

  <!-- Tela Jogo -->
  <section id="telaJogo" class="card hidden">
    <div id="mensagem" class="p"></div>
    <div id="opcoesJogo" class="controls"></div>
    <div id="output" class="output" aria-live="polite"></div>
  </section>

  <!-- Tela Batalha -->
  <section id="telaBatalha" class="card hidden">
    <div class="title">BATALHA</div>
    <div id="mensagemBatalha" class="p"></div>
    <div id="rolagemDados" class="output"></div>
    <div class="controls" id="botoesBatalha">
      <button class="btn" id="btnAtacar" onclick="playerAttack()">Atacar</button>
      <button class="btn btn-secondary" onclick="defender()">Defender</button>
      <button class="btn btn-secondary" onclick="fugir()">Fugir</button>
      <button class="btn btn-danger hidden" id="btnDarPropina" onclick="darPropinaBatalha()">Dar Propina (2 ouro)</button>
    </div>
  </section>

  <!-- Tela Perfil / Invent√°rio -->
  <section id="telaPerfil" class="card hidden">
    <div class="title">Perfil do Jogador</div>
    <div id="perfilAtributos" class="p small"></div>

    <div style="margin-top:12px">
      <div class="small">Invent√°rio (3 slots)</div>
      <ul id="listaItens" class="inventory small" style="margin-top:8px"></ul>
      <div style="margin-top:8px">
        <button class="btn" onclick="colocarMaoOpcoes()">Colocar item na m√£o</button>
        <button class="btn btn-secondary" onclick="usarItemMao()">Usar item na m√£o</button>
        <button class="btn btn-danger" onclick="removerItemMao()">Descartar item na m√£o</button>
      </div>
      <div style="margin-top:12px" class="small">M√£o: <span id="itemMao">Vazio</span></div>
    </div>

    <div class="controls" style="margin-top:10px">
      <button class="btn btn-secondary" onclick="mostrarTela('telaJogo')">Voltar</button>
    </div>
  </section>

  <footer>Touch-friendly ‚Äî projetado para celular. Salve este arquivo como <code>index.html</code> e publique no GitHub Pages.</footer>
</main>

<script>
/* ===========================
   Jogo completo consolidado
   =========================== */

/* Player state (persistido) */
const STORAGE_KEY = 'rpg_betsim_save_v1';
let player = {
  nome: "",
  vigor: 3,
  forca: 3,
  destreza: 2,
  armadura: 2,
  pv: 30,
  nivel: 1,
  xp: 0,
  ouro: 50,
  inventario: [null, null, null],
  mao: null,             // 'Espada +2' | 'Por√ß√£o' | 'ouro' etc
  fragments: [false,false,false,false], // 4 partes
  propinaUnlocked: false // deve ser ativado ao clicar ouro durante conversa/batalha e <=20 ouro
};

let state = {
  inBattle: false,
  inConversation: false,
  currentEnemy: null,
  diceInterval: null,
  diceAnimationRunning: false
};

/* --- Utilit√°rios de tela/navega√ß√£o --- */
function mostrarTela(id){
  const telas = ['telaInicial','telaFicha','telaJogo','telaBatalha','telaPerfil'];
  telas.forEach(t => document.getElementById(t).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  toggleMenu(false);
}
function toggleMenu(force){
  const el = document.getElementById('menuOpcao');
  if(typeof force==='boolean'){
    el.classList.toggle('hidden', !force);
  } else {
    el.classList.toggle('hidden');
  }
}
function pauseJogo(){ alert('Jogo pausado.'); toggleMenu(false); }
function sairJogo(){ if(confirm('Sair do jogo apaga a ficha. Confirmar?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function reiniciarJogo(){ if(confirm('Reiniciar ficha?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } }

/* --- Salvamento / Carregamento --- */
function saveGame(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(player));
  }catch(e){ console.warn('salvar falhou', e); }
}
function loadGame(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      Object.assign(player, obj);
      player.pv = Number(player.pv) || player.vigor*10;
      return true;
    }
  }catch(e){ console.warn('load fail', e); }
  return false;
}

/* --- HUD e Perfil --- */
function atualizarHUD(){
  const fBonus = (player.mao && player.mao.includes('Espada')) ? 2 : 0;
  const Ftot = player.forca + fBonus;
  document.getElementById('nomeJogador').innerText = player.nome || 'Jogador';
  document.getElementById('atributosJogador').innerText =
    `PV:${player.pv} Ouro:${player.ouro} M√£o:${player.mao||'Vazio'} V(${player.vigor}) F(${player.forca}${fBonus?`+${fBonus}`:''})=${Ftot} D(${player.destreza}) A(${player.armadura})`;
  atualizarPerfil();
  saveGame();
}
function atualizarPerfil(){
  const fBonus = (player.mao && player.mao.includes('Espada')) ? 2 : 0;
  const Ftot = player.forca + fBonus;
  document.getElementById('perfilAtributos').innerHTML =
    `<div><strong>${escapeHtml(player.nome||'Jogador')}</strong> ‚Äî N√≠vel ${player.nivel} XP:${player.xp}</div>
     <div class="small">PV: ${player.pv}</div>
     <div class="small">V(${player.vigor}) F(${player.forca}${fBonus?`+${fBonus}`:''})=${Ftot} D(${player.destreza}) A(${player.armadura})</div>
     <div class="small">Ouro: <span style="color:#f1c40f;cursor:pointer" onclick="goldClicked()">${player.ouro}</span></div>
     <div class="small">M√£o: ${player.mao||'Vazio'}</div>`;
  const ul = document.getElementById('listaItens');
  ul.innerHTML = '';
  player.inventario.forEach((it, i) => {
    const li = document.createElement('li');
    li.innerHTML = `<span>${it || 'Vazio'}</span> 
      <button class="btn btn-secondary" onclick="colocarMao(${i})">Colocar na m√£o</button>
      <button class="btn btn-danger" onclick="descartarItem(${i})">Descartar</button>`;
    ul.appendChild(li);
  });
  document.getElementById('itemMao').innerText = player.mao || 'Vazio';
}

/* escape b√°sico para logs */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* --- Tela Inicial / Ficha --- */
function editarFicha(){
  // preencher inputs se houver save
  document.getElementById('inputNome').value = player.nome || '';
  document.getElementById('attrVigor').value = player.vigor;
  document.getElementById('attrForca').value = player.forca;
  document.getElementById('attrDestreza').value = player.destreza;
  document.getElementById('attrArmadura').value = player.armadura;
  atualizaPontos();
  mostrarTela('telaFicha');
}
function atualizaPontos(){
  const v = Number(document.getElementById('attrVigor').value) || 0;
  const f = Number(document.getElementById('attrForca').value) || 0;
  const d = Number(document.getElementById('attrDestreza').value) || 0;
  const a = Number(document.getElementById('attrArmadura').value) || 0;
  const total = v+f+d+a;
  document.getElementById('pontosDisponiveis').innerText = Math.max(0,10-total);
  document.getElementById('mensagemFicha').innerText = total>10 ? 'Voc√™ excedeu os pontos!' : '';
}
function salvarFicha(){
  // valida√ß√£o simples
  const v = Number(document.getElementById('attrVigor').value) || 0;
  const f = Number(document.getElementById('attrForca').value) || 0;
  const d = Number(document.getElementById('attrDestreza').value) || 0;
  const a = Number(document.getElementById('attrArmadura').value) || 0;
  const total = v+f+d+a;
  if(total>10) return alert('Distribua exatamente at√© 10 pontos.');
  player.nome = (document.getElementById('inputNome').value||'Jogador').trim();
  player.vigor = v; player.forca = f; player.destreza = d; player.armadura = a;
  player.pv = player.vigor*10;
  // ensure arrays
  player.inventario = player.inventario || [null,null,null];
  player.fragments = player.fragments || [false,false,false,false];
  saveGame(); atualizarHUD();
  document.getElementById('btnIniciarJogo').classList.remove('hidden');
  document.getElementById('btnCriarFicha').classList.add('hidden');
  document.getElementById('msgCrieFicha').classList.add('hidden');
  mostrarTela('telaInicial');
  alert('Ficha salva!');
}

/* --- Iniciar aventura / op√ß√µes principais --- */
function iniciarJogo(){
  mostrarTela('telaJogo');
  logOut(`üëë Rei Robert: "Her√≥i ${escapeHtml(player.nome)}, recupere os 4 fragmentos da chave. Procure pistas em cidade, floresta, ru√≠nas e montanha."`);
  opcoesAventura();
  atualizarHUD();
}
function opcoesAventura(){
  state.inBattle = false; state.inConversation = false; state.currentEnemy = null;
  const el = document.getElementById('opcoesJogo');
  el.innerHTML = '';
  addAction('Ir √† cidade', irCidade);
  addAction('Ir √† floresta', irFloresta);
  addAction('Explorar Ru√≠nas', entrarRuinas);
  addAction('Subir Montanha', irMontanha);
  addAction('Checar invent√°rio', ()=>mostrarTela('telaPerfil'));
  maybeShowPropina();
}
function addAction(label,fn){ const btn=document.createElement('button'); btn.className='btn'; btn.innerText=label; btn.onclick=fn; document.getElementById('opcoesJogo').appendChild(btn); }

/* --- Locais e narrativa com fragments --- */
function irCidade(){
  state.inConversation = true;
  logOut('üèôÔ∏è Voc√™ chega √† cidade ‚Äî vendedores, alde√µes e rumores.');
  const el = document.getElementById('opcoesJogo'); el.innerHTML='';
  addAction('Ir √† loja', visitarLoja);
  addAction('Conversar com o alde√£o', conversaAldeaoCidade);
  addAction('Voltar', opcoesAventura);
  maybeShowPropina();
}
function visitarLoja(){
  logOut('üõí Loja: Espada +2 (20 ouro), Por√ß√£o (+10 PV) (10 ouro).');
  const el=document.getElementById('opcoesJogo'); el.innerHTML='';
  addAction('Comprar Espada +2 (20 ouro)', ()=>comprar('Espada +2',20));
  addAction('Comprar Por√ß√£o (10 ouro)', ()=>comprar('Por√ß√£o',10));
  addAction('Voltar', irCidade);
}
function comprar(item, cost){
  if(player.ouro < cost) return logOut('‚ùå Ouro insuficiente.');
  const slot = player.inventario.indexOf(null);
  if(slot === -1) return logOut('‚ùå Invent√°rio cheio.');
  player.inventario[slot] = item;
  player.ouro -= cost;
  saveGame(); atualizarHUD();
  logOut(`‚úÖ Comprou ${item}.`);
  visitarLoja();
}
function conversaAldeaoCidade(){
  logOut('üßë‚Äçüåæ Alde√£o: "Dizem que um fragmento foi visto perto das ru√≠nas... mas cuidado com guardi√µes."');
  const el=document.getElementById('opcoesJogo'); el.innerHTML='';
  addAction('Pedir mais informa√ß√µes (pode custar algo)', ()=>{ logOut('O alde√£o pede uma gorjeta...'); addAction('Pagar gorjeta 5 ouro', ()=>{ if(player.ouro>=5){ player.ouro-=5; logOut('O alde√£o confidencia uma pista: "Busque no altar das ru√≠nas."'); atualizarHUD(); } else logOut('Voc√™ n√£o tem 5 ouro.'); }); });
  addAction('Voltar', irCidade);
  maybeShowPropina();
}

/* Floresta (fragment 1) */
function irFloresta(){
  state.inBattle = true; state.inConversation = false;
  logOut('üå≤ Voc√™ penetra na floresta e encontra um sentinela goblin.');
  startBattle({nome:'Sentinela Goblin', pv: 18, armadura:2, forca:3, destreza:2, xp:20, dropFragment:0});
}

/* Ru√≠nas (puzzle/miniq) fragment 2 */
function entrarRuinas(){
  state.inConversation = true;
  logOut('üèõ Ru√≠nas antigas: uma sala com tr√™s inscri√ß√µes. Um enigma espera.');
  const el = document.getElementById('opcoesJogo'); el.innerHTML='';
  addAction('Ler inscri√ß√£o A', ()=>resolverEnigma('A'));
  addAction('Ler inscri√ß√£o B', ()=>resolverEnigma('B'));
  addAction('Ler inscri√ß√£o C', ()=>resolverEnigma('C'));
  addAction('Voltar', opcoesAventura);
}
function resolverEnigma(op){
  // escolha ramificada: apenas B √© a correta nesta cena (exemplo)
  if(op==='B'){
    logOut('‚úÖ Ao ler B, um compartimento se abre ‚Äî dentro est√° um fragmento da chave!');
    player.fragments[1] = true; saveGame();
    mostrarTela('telaJogo');
    opcoesAventura();
  } else {
    logOut('‚ùå A inscri√ß√£o ativa uma armadilha ‚Äî surge um arqueiro das ru√≠nas!');
    state.inBattle = true; startBattle({nome:'Arqueiro das Ru√≠nas', pv:22, armadura:3, forca:3, destreza:3, xp:25, dropFragment: -1});
  }
}

/* Montanha (fragment 3 - miniboss) */
function irMontanha(){
  state.inConversation=false; state.inBattle=true;
  logOut('‚õ∞Ô∏è Ao subir a montanha, um Lobo Alfa bloqueia o caminho.');
  startBattle({nome:'Lobo Alfa', pv:26, armadura:3, forca:4, destreza:3, xp:30, dropFragment:2});
}

/* Caverna final (fragment 4 atr√°s do drag√£o) - exigir√° tr√™s fragments para encontrar o fragmento final e o drag√£o */
function entrarCaverna(){
  // s√≥ permita se tiver tr√™s fragments
  const haveCount = player.fragments.filter(Boolean).length;
  if(haveCount < 3){
    logOut('üîí A caverna est√° selada. Faltam fragmentos para abrir o portal da c√¢mara interior.');
    opcoesAventura();
    return;
  }
  state.inConversation=false; state.inBattle=true;
  logOut('üï≥Ô∏è A c√¢mara se abre ‚Äî o Drag√£o de Luparus aparece!');
  startBattle({nome:'Drag√£o Luparus', pv:120, armadura:8, forca:8, destreza:5, xp:500, dropFragment:3, isBoss:true});
}

/* --- Batalha completa com rolagem animada --- */
function startBattle(enemy){
  state.currentEnemy = enemy;
  mostrarTela('telaBatalha');
  document.getElementById('mensagemBatalha').innerText = `Enfrentando: ${enemy.nome} ‚Äî PV: ${enemy.pv}`;
  document.getElementById('rolagemDados').innerText = '';
  atualizarHUD();
  // mostrar propina se eleg√≠vel
  maybeShowPropina();
}

function playerAttack(){
  if(state.diceAnimationRunning) return;
  if(!state.currentEnemy) return;
  const enemy = state.currentEnemy;
  diceRollAnimation(3500, (playerDiceFinal)=>{
    // c√°lculo do ataque
    const weaponBonus = (player.mao && player.mao.includes('Espada')) ? 2 : 0;
    const atk = playerDiceFinal + player.destreza + weaponBonus;
    const enemyDefDice = rollOnce();
    const def = enemyDefDice + (enemy.armadura || 0);
    appendRollLog(`Voc√™: Dado ${playerDiceFinal} + Destreza(${player.destreza})${weaponBonus?` + Espada(${weaponBonus})`:''} = Ataque ${atk}`);
    appendRollLog(`${enemy.nome}: Dado ${enemyDefDice} + Armadura(${enemy.armadura||0}) = Defesa ${def}`);
    let dano = Math.max(0, atk - def);
    enemy.pv -= dano;
    appendRollLog(`Dano causado: ${dano} ‚Äî PV inimigo: ${Math.max(0,enemy.pv)}`);
    if(enemy.pv <= 0){
      // vit√≥ria
      appendRollLog(`üí• Voc√™ derrotou ${enemy.nome}!`);
      ganharRecompensa(enemy);
      finalizarBatalha();
    } else {
      // inimigo contra-ataca
      setTimeout(()=>enemyTurn(enemy), 900);
    }
  });
}

function enemyTurn(enemy){
  // anima√ß√£o do dado inimigo
  if(!enemy) return;
  diceRollAnimation(3000,(dadoInimigo)=>{
    const atkInim = dadoInimigo + (enemy.destreza || 0) + (enemy.forca || 0);
    const defJogDice = rollOnce();
    const defJog = defJogDice + player.armadura;
    appendRollLog(`${enemy.nome} ataca: Dado ${dadoInimigo} + For√ßa(${enemy.forca||0}) = ${atkInim}`);
    appendRollLog(`Voc√™ defende: Dado ${defJogDice} + Armadura(${player.armadura}) = ${defJog}`);
    let dano = Math.max(0, atkInim - defJog);
    player.pv -= dano;
    appendRollLog(`Voc√™ recebeu: ${dano} ‚Äî Seu PV: ${Math.max(0, player.pv)}`);
    atualizarHUD();
    if(player.pv <= 0){
      appendRollLog('üíÄ Voc√™ foi derrotado. Retorne √† cidade para curar-se.');
      finalizarBatalha(true);
    } else {
      // permitir pr√≥xima a√ß√£o
      maybeShowPropina();
    }
  });
}

function defender(){
  appendRollLog('Voc√™ assume posi√ß√£o defensiva ‚Äî reduz dano no pr√≥ximo ataque.');
  // simples: reduzir o pr√≥ximo dano pela metade ‚Äî aqui simplificamos aplicando um buff tempor√°rio.
  player._defending = true;
  maybeShowPropina();
}

function fugir(){
  if(confirm('Deseja tentar fugir? (Chance de sucesso 60%)')){
    if(Math.random() < 0.6){
      appendRollLog('Voc√™ fugiu com sucesso!');
      finalizarBatalha();
    } else {
      appendRollLog('A fuga falhou ‚Äî inimigo ataca!');
      if(state.currentEnemy) enemyTurn(state.currentEnemy);
    }
  }
}

/* dice animation helper */
function diceRollAnimation(durationMs, onComplete){
  // mostra anima√ß√£o de n√∫meros mudando rapidamente por durationMs e no final chama onComplete com final value
  if(state.diceAnimationRunning) return;
  state.diceAnimationRunning = true;
  const el = document.getElementById('rolagemDados');
  el.innerText = 'Rolando dados...';
  let ticks = 0;
  const interval = 60; // ms
  const maxTicks = Math.floor(durationMs/interval);
  let last = null;
  state.diceInterval = setInterval(()=>{
    const n = Math.floor(Math.random()*6) + 1;
    el.innerText = `... ${n} ...`;
    last = n;
    ticks++;
    if(ticks >= maxTicks){
      clearInterval(state.diceInterval); state.diceAnimationRunning = false;
      el.innerText = `Resultado: ${last}`;
      onComplete(last);
    }
  }, interval);
}

/* finalize battle (victory or defeat) */
function finalizarBatalha(defeat=false){
  state.inBattle = false;
  state.currentEnemy = null;
  mostrarTela('telaJogo');
  if(defeat){
    // penalidade: perder metade do ouro? simple: perder 10 ouro or to 0
    const perda = Math.min(player.ouro,10);
    player.ouro -= perda;
    player.pv = Math.max(1, Math.floor(player.vigor*10/2)); // respawn com metade do vigor
    logOut(`Voc√™ perdeu a batalha e perdeu ${perda} ouro. PV restaurado parcialmente.`);
  } else {
    logOut('Volte para a explora√ß√£o.');
  }
  atualizarHUD();
  opcoesAventura();
}

/* darse recompensa ao vencer */
function ganharRecompensa(enemy){
  if(!enemy) return;
  player.xp = (player.xp || 0) + (enemy.xp || 10);
  // drop fragment?
  if(typeof enemy.dropFragment === 'number' && enemy.dropFragment >= 0){
    if(!player.fragments[enemy.dropFragment]){
      player.fragments[enemy.dropFragment] = true;
      logOut(`üî∑ Voc√™ obteve um fragmento da chave (Parte ${enemy.dropFragment+1})!`);
    }
  }
  // level up check
  if(player.xp >= player.nivel * 100){
    player.nivel++;
    alert('üéâ Voc√™ subiu de n√≠vel! Recebe 1 ponto para distribuir.');
    // grant 1 point to add to any attribute via prompt (simple)
    const escolha = prompt('Escolha um atributo para aumentar: vigor, forca, destreza, armadura').toLowerCase();
    if(escolha === 'vigor') player.vigor++;
    else if(escolha === 'forca') player.forca++;
    else if(escolha === 'destreza') player.destreza++;
    else if(escolha === 'armadura') player.armadura++;
    player.xp = 0;
  }
  saveGame();
  atualizarHUD();
}

/* roll once helper */
function rollOnce(){ return Math.floor(Math.random()*6)+1; }

/* append log to battle roll area */
function appendRollLog(text){
  const el = document.getElementById('rolagemDados');
  el.innerText += (el.innerText?'\n':'') + text;
}

/* quick log to main output */
function logOut(text){
  const out = document.getElementById('output');
  out.innerHTML += `<div>${escapeHtml(text)}</div>`;
  out.scrollTop = out.scrollHeight;
}

/* --- Inventory / M√£o --- */
function colocarMao(index){
  const it = player.inventario[index];
  if(!it) return alert('Slot vazio.');
  player.mao = it;
  player.inventario[index] = null;
  logOut(`Voc√™ colocou ${player.mao} na m√£o.`);
  atualizarHUD(); saveGame();
}
function descartarItem(index){
  if(!player.inventario[index]) return alert('Slot vazio.');
  if(confirm('Deseja descartar este item permanentemente?')){
    logOut(`Descartou ${player.inventario[index]}.`);
    if(player.mao === player.inventario[index]) player.mao = null;
    player.inventario[index] = null;
    atualizarHUD(); saveGame();
  }
}
function colocarMaoOpcoes(){
  // Mostra op√ß√µes simples: escolher √≠ndice por prompt (mobile friendly)
  const choices = player.inventario.map((it,i)=>`${i+1}:${it||'Vazio'}`).join(' | ');
  const pick = prompt('Escolha slot para colocar na m√£o:\n' + choices + '\nDigite n√∫mero do slot (1-3)');
  const idx = Number(pick)-1;
  if(isNaN(idx) || idx < 0 || idx > 2) return;
  colocarMao(idx);
}
function usarItemMao(){
  if(!player.mao) return alert('Nada na m√£o.');
  if(player.mao.includes('Por√ß√£o')){
    player.pv += 10;
    if(player.pv > player.vigor*10) player.pv = player.vigor*10;
    // remove por√ß√£o do invent√°rio (if present in any slot)
    const slot = player.inventario.indexOf(player.mao);
    if(slot>=0) player.inventario[slot] = null;
    logOut('Usou por√ß√£o +10PV.');
    player.mao = null;
    atualizarHUD(); saveGame();
  } else if(player.mao==='ouro'){
    alert('Ouro na m√£o. Use propina (quando desbloqueado) em conversas ou batalhas.');
  } else {
    alert('Item na m√£o n√£o us√°vel diretamente (espada equipada para b√¥nus).');
  }
}
function removerItemMao(){
  if(!player.mao) return alert('Nada na m√£o.');
  if(confirm(`Descartar ${player.mao} da m√£o?`)){
    // se item estiver tamb√©m no invent√°rio, remove a inst√¢ncia (we treat m√£o as unique)
    player.mao = null;
    logOut('Item descartado da m√£o.');
    atualizarHUD(); saveGame();
  }
}

/* colocar ouro na m√£o (especial) */
function colocarOuroNaMao(){
  if(player.ouro <= 0) return alert('Voc√™ n√£o tem ouro para colocar na m√£o.');
  player.mao = 'ouro';
  logOut('Voc√™ colocou ouro na m√£o (n√£o remove o ouro do contador; √© uma representa√ß√£o para propina).');
  atualizarHUD(); saveGame();
}

/* --- Propina: Easter egg activation and use --- */
function goldClicked(){
  // activation rule: must click if inBattle or inConversation AND player.ouro <= 20
  if((state.inBattle || state.inConversation) && player.ouro <= 20 && !player.propinaUnlocked){
    player.propinaUnlocked = true;
    alert('‚ú® Easter egg encontrado: agora voc√™ pode usar ouro como propina (coloque "ouro" na m√£o via invent√°rio: "Colocar ouro na m√£o").');
    updatePropinaUI();
    saveGame();
    logOut('Easter egg: propina desbloqueada!');
    return;
  }
  // otherwise just informative
  logOut('üí∞ Ouro: ' + player.ouro);
}

/* show propina button where relevant */
function maybeShowPropina(){
  // If unlocked and ouro in hand and in a conversation or battle, show button on appropriate UI
  const hasPropina = player.propinaUnlocked && player.mao === 'ouro' && (state.inBattle || state.inConversation);
  // show on battle UI
  const btnB = document.getElementById('btnDarPropina');
  if(btnB) btnB.classList.toggle('hidden', !hasPropina);
  // in main options, append a propina action
  const actionsEl = document.getElementById('opcoesJogo');
  // remove existing propina action if any
  const existing = document.getElementById('action-propina');
  if(existing) existing.remove();
  if(hasPropina && !state.inBattle){ // show as normal action in conversation
    const btn = document.createElement('button');
    btn.id = 'action-propina';
    btn.className = 'btn';
    btn.innerText = 'Dar propina (2 ouro)';
    btn.onclick = darPropinaConversa;
    actionsEl.appendChild(btn);
  }
}

/* Using propina in battle */
function darPropinaBatalha(){
  if(!player.propinaUnlocked || player.mao !== 'ouro' || !state.inBattle) return alert('Propina n√£o dispon√≠vel.');
  if(player.ouro < 2) return logOut('Voc√™ n√£o tem 2 ouro para propina.');
  player.ouro -= 2;
  player.nivel = Math.max(1, player.nivel - 1);
  logOut('üí∏ Voc√™ pagou propina e fugiu! Voc√™ perdeu 1 n√≠vel. (Voc√™ √© um frouxo)');
  state.inBattle = false;
  state.currentEnemy = null;
  player.mao = null;
  atualizarHUD(); saveGame();
  mostrarTela('telaJogo');
  opcoesAventura();
}

/* Using propina in conversation */
function darPropinaConversa(){
  if(!player.propinaUnlocked || player.mao !== 'ouro' || !state.inConversation) return alert('Propina n√£o dispon√≠vel.');
  if(player.ouro < 2) return logOut('Voc√™ n√£o tem 2 ouro para propina.');
  player.ouro -= 2;
  // show privileged info (example)
  logOut('üí∏ Voc√™ d√° propina. O NPC sussurra: "Um fragmento foi escondido no altar ao norte ‚Äî siga a trilha das pedras vermelhas."');
  // after using, you can still use again if have ouro and keep ouro in hand
  atualizarHUD(); saveGame();
  opcoesAventura();
}

/* update UI elements for propina */
function updatePropinaUI(){
  maybeShowPropina();
}

/* --- Simple helper functions for flow --- */
function startBattle(enemy){
  state.inBattle = true; state.inConversation = false;
  state.currentEnemy = Object.assign({}, enemy);
  mostrarTela('telaBatalha');
  document.getElementById('mensagemBatalha').innerText = `Inimigo: ${enemy.nome} ‚Äî PV: ${enemy.pv}`;
  document.getElementById('rolagemDados').innerText = '';
  atualizarHUD();
  maybeShowPropina();
}
function finalizarBatalhaSimples(){
  state.inBattle = false; state.currentEnemy = null;
  mostrarTela('telaJogo'); opcoesAventura(); atualizarHUD();
}

/* --- Helper: start battle and enemy config example reuse --- */
/* already defined earlier in various places */

/* --- Utility: start point on load --- */
function init(){
  const had = loadGame();
  if(had){
    // player loaded
    document.getElementById('btnIniciarJogo').classList.remove('hidden');
    document.getElementById('btnCriarFicha').classList.add('hidden');
    document.getElementById('msgCrieFicha').classList.add('hidden');
    atualizarHUD();
  } else {
    // defaults
    player.pv = player.vigor*10;
    document.getElementById('btnIniciarJogo').classList.add('hidden');
    document.getElementById('btnCriarFicha').classList.remove('hidden');
    document.getElementById('msgCrieFicha').classList.remove('hidden');
  }
  mostrarTela('telaInicial');
  attachGlobalActions();
}

/* attach buttons that require dynamic wiring (shop buy etc) */
function attachGlobalActions(){
  // place special inventory action: place ouro in hand
  // user can use inventory -> "Colocar ouro na m√£o" via opcoes in open inventory
  // but we also provide global quick option: when in perfil, there's button to put ouro in hand (via colocarOuroNaMao)
  // We add a visible action to 'telaPerfil' area:
  const perfilNode = document.getElementById('telaPerfil');
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '12px';
  wrapper.innerHTML = `<button class="btn" onclick="colocarOuroNaMao()">Colocar Ouro na M√£o (easter-usage)</button>`;
  perfilNode.appendChild(wrapper);
}

/* show main propina check on action renders */
function maybeShowPropinaGlobal(){
  maybeShowPropina();
}

/* small helper to ensure button availability when opcoes change */
document.addEventListener('click', ()=>{ maybeShowPropina(); });

/* init */
init();

/* Expose some functions to global for html onclicks used in strings */
window.mostrarTela = mostrarTela;
window.editarFicha = editarFicha;
window.salvarFicha = salvarFicha;
window.iniciarJogo = iniciarJogo;
window.atualizaPontos = atualizaPontos;
window.abrirPerfil = ()=>mostrarTela('telaPerfil');
window.colocarMao = colocarMao;
window.descartarItem = descartarItem;
window.usarItemMao = usarItemMao;
window.removerItemMao = removerItemMao;
window.colocarMaoOpcoes = colocarMaoOpcoes;
window.colocarOuroNaMao = colocarOuroNaMao;
window.goldClicked = goldClicked;
window.darPropinaBatalha = darPropinaBatalha;
window.darPropinaConversa = darPropinaConversa;
window.visitarLoja = visitarLoja;
window.comprar = (it,cost)=>comprar(it,cost);
window.irFloresta = irFloresta;
window.irCidade = irCidade;
window.entrarRuinas = entrarRuinas;
window.irMontanha = irMontanha;
window.entrarCaverna = entrarCaverna;

/* End of script */
</script>
</body>
</html>
